<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Live Attendance Tracker</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            background: white;
            padding: 20px 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 {
            color: #333;
            font-size: 28px;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 14px;
        }

        .connection-status.connected {
            background: #d4edda;
            color: #155724;
        }

        .connection-status.disconnected {
            background: #f8d7da;
            color: #721c24;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-dot.connected {
            background: #28a745;
        }

        .status-dot.disconnected {
            background: #dc3545;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }

        .stat-card.total { border-left: 5px solid #667eea; }
        .stat-card.checked-in { border-left: 5px solid #28a745; }
        .stat-card.checked-out { border-left: 5px solid #ffc107; }
        .stat-card.absent { border-left: 5px solid #dc3545; }

        .stat-label {
            font-size: 14px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }

        .stat-value {
            font-size: 42px;
            font-weight: bold;
            color: #333;
        }

        .stat-icon {
            font-size: 24px;
            margin-bottom: 10px;
        }

        .employees-section {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #eee;
        }

        .section-title {
            font-size: 22px;
            color: #333;
        }

        .refresh-badge {
            background: #667eea;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .employees-table {
            width: 100%;
            border-collapse: collapse;
            overflow: hidden;
        }

        .employees-table thead {
            background: #f8f9fa;
        }

        .employees-table th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: #555;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .employees-table td {
            padding: 15px;
            border-bottom: 1px solid #eee;
            color: #333;
        }

        .employees-table tbody tr {
            transition: background 0.2s ease;
        }

        .employees-table tbody tr:hover {
            background: #f8f9fa;
        }

        .status-badge {
            padding: 5px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-badge.checked-in {
            background: #d4edda;
            color: #155724;
        }

        .status-badge.checked-out {
            background: #fff3cd;
            color: #856404;
        }

        .status-badge.absent {
            background: #f8d7da;
            color: #721c24;
        }

        .activity-log {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            max-height: 400px;
            overflow-y: auto;
        }

        .log-entry {
            padding: 12px;
            margin-bottom: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            font-size: 14px;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes flash {
            0%, 100% { background: white; }
            50% { background: #d4edda; }
        }

        .log-time {
            color: #999;
            font-size: 12px;
            margin-left: 10px;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
            font-size: 18px;
        }

        .test-card {
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 2px solid #e9ecef;
        }

        .test-input {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .test-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .test-button {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            color: white;
        }

        .test-button.add {
            background: #28a745;
        }

        .test-button.add:hover {
            background: #218838;
            transform: translateY(-2px);
        }

        .test-button.delete {
            background: #dc3545;
        }

        .test-button.delete:hover {
            background: #c82333;
            transform: translateY(-2px);
        }

        .test-button.edit {
            background: #667eea;
        }

        .test-button.edit:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }

        .test-result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 6px;
            font-size: 13px;
            display: none;
        }

        .test-result.success {
            background: #d4edda;
            color: #155724;
            display: block;
        }

        .test-result.error {
            background: #f8d7da;
            color: #721c24;
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üéØ Admin Dashboard</h1>
            <div id="connectionStatus" class="connection-status disconnected">
                <div class="status-dot disconnected"></div>
                <span>Connecting...</span>
            </div>
        </header>

        <!-- Stats Cards -->
        <div class="stats-grid">
            <div class="stat-card total">
                <div class="stat-icon">üë•</div>
                <div class="stat-label">Total Employees</div>
                <div class="stat-value" id="totalEmployees">--</div>
            </div>
            <div class="stat-card checked-in">
                <div class="stat-icon">‚úÖ</div>
                <div class="stat-label">Checked In</div>
                <div class="stat-value" id="checkedIn">--</div>
            </div>
            <div class="stat-card checked-out">
                <div class="stat-icon">üö™</div>
                <div class="stat-label">Checked Out</div>
                <div class="stat-value" id="checkedOut">--</div>
            </div>
            <div class="stat-card absent">
                <div class="stat-icon">‚ùå</div>
                <div class="stat-label">Absent</div>
                <div class="stat-value" id="absent">--</div>
            </div>
        </div>

        <!-- Employees Table -->
        <div class="employees-section">
            <div class="section-header">
                <h2 class="section-title">üìã Employee List</h2>
                <span class="refresh-badge" id="lastUpdate">Live Updates</span>
            </div>
            <div id="employeesTableContainer">
                <div class="loading">Loading employees...</div>
            </div>
        </div>

        <!-- Activity Log -->
        <div class="activity-log">
            <div class="section-header">
                <h2 class="section-title">üìä Activity Log</h2>
            </div>
            <div id="activityLog"></div>
        </div>

        <!-- Test Panel -->
        <div class="employees-section" style="margin-top: 20px;">
            <div class="section-header">
                <h2 class="section-title">üß™ Socket.IO Test Panel</h2>
            </div>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                <div class="test-card">
                    <h3 style="margin-bottom: 15px; color: #333;">‚ûï Add Test Employee</h3>
                    <input type="text" id="firstName" placeholder="First Name" class="test-input">
                    <input type="text" id="lastName" placeholder="Last Name" class="test-input">
                    <input type="email" id="email" placeholder="Email" class="test-input">
                    <input type="text" id="contact" placeholder="Contact Number" class="test-input">
                    <button onclick="addTestEmployee()" class="test-button add">Add Employee</button>
                    <div id="addResult" class="test-result"></div>
                </div>
                
                <div class="test-card">
                    <h3 style="margin-bottom: 15px; color: #333;">üóëÔ∏è Delete Employee</h3>
                    <input type="text" id="deleteId" placeholder="Employee ID" class="test-input">
                    <button onclick="deleteTestEmployee()" class="test-button delete">Delete Employee</button>
                    <div id="deleteResult" class="test-result"></div>
                </div>

                <div class="test-card">
                    <h3 style="margin-bottom: 15px; color: #333;">‚úèÔ∏è Edit Employee</h3>
                    <input type="text" id="editId" placeholder="Employee ID" class="test-input">
                    <input type="text" id="editLastName" placeholder="New Last Name" class="test-input">
                    <input type="email" id="editEmail" placeholder="New Email" class="test-input">
                    <button onclick="editTestEmployee()" class="test-button edit">Update Employee</button>
                    <div id="editResult" class="test-result"></div>
                </div>
            </div>
            <div style="margin-top: 20px; padding: 15px; background: #fff3cd; border-radius: 8px; border-left: 4px solid #ffc107;">
                <strong>üí° How to test:</strong>
                <ol style="margin: 10px 0 0 20px; line-height: 1.8;">
                    <li>Add a new employee and watch the employee list update instantly</li>
                    <li>Delete an employee by ID and see it disappear in real-time</li>
                    <li>Edit an employee's details and watch the changes appear</li>
                    <li>Check the Activity Log below for Socket.IO events</li>
                </ol>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:9090';
        const socket = io(API_URL);

        // Connection status
        const statusElement = document.getElementById('connectionStatus');
        
        socket.on('connect', () => {
            console.log('‚úÖ Connected to server:', socket.id);
            statusElement.className = 'connection-status connected';
            statusElement.innerHTML = '<div class="status-dot connected"></div><span>Connected</span>';
            addLog('Connected to server', 'success');
            
            // Fetch initial data
            fetchInitialData();
        });

        socket.on('disconnect', () => {
            console.log('‚ùå Disconnected from server');
            statusElement.className = 'connection-status disconnected';
            statusElement.innerHTML = '<div class="status-dot disconnected"></div><span>Disconnected</span>';
            addLog('Disconnected from server', 'error');
        });

        // Listen for employee updates
        socket.on('employees:update', (employees) => {
            console.log('üßë‚Äçüíº Employees updated:', employees);
            addLog(`üöÄ SOCKET.IO EVENT: Employees list updated (${employees.length} employees)`, 'success');
            renderEmployeesTable(employees);
            document.getElementById('lastUpdate').textContent = `Updated ${new Date().toLocaleTimeString()}`;
            
            // Flash animation on the table
            const tableContainer = document.getElementById('employeesTableContainer');
            tableContainer.style.animation = 'flash 0.5s';
            setTimeout(() => {
                tableContainer.style.animation = '';
            }, 500);
        });

        // Listen for admin stats updates
        socket.on('admin:stats:update', (stats) => {
            console.log('üìä Admin stats updated:', stats);
            updateStats(stats);
            addLog('Dashboard stats refreshed', 'info');
        });

        // Listen for clock in/out updates
        socket.on('clockinout:update', (data) => {
            console.log('üïê Clock in/out updated:', data);
            addLog('Clock in/out data updated', 'info');
        });

        // Fetch initial data from API
        async function fetchInitialData() {
            try {
                // Fetch stats
                const [totalRes, checkedInRes, checkedOutRes, absentRes] = await Promise.all([
                    fetch(`${API_URL}/totalEmployees`),
                    fetch(`${API_URL}/checkedIn`),
                    fetch(`${API_URL}/checkedOut`),
                    fetch(`${API_URL}/absent`)
                ]);

                const total = await totalRes.json();
                const checkedIn = await checkedInRes.json();
                const checkedOut = await checkedOutRes.json();
                const absent = await absentRes.json();

                // Extract the actual count from the nested object/array
                const totalCount = extractCount(total.total_employees);
                const checkedInCount = extractCount(checkedIn.checked_in);
                const checkedOutCount = extractCount(checkedOut.checked_out);
                const absentCount = extractCount(absent.absent);

                document.getElementById('totalEmployees').textContent = totalCount;
                document.getElementById('checkedIn').textContent = checkedInCount;
                document.getElementById('checkedOut').textContent = checkedOutCount;
                document.getElementById('absent').textContent = absentCount;

                addLog('Initial stats loaded', 'success');

                // Fetch employees (try filterAll or clockInOut)
                const employeesRes = await fetch(`${API_URL}/filterAll`).catch(() => 
                    fetch(`${API_URL}/clockInOut`)
                );
                const employeesData = await employeesRes.json();
                
                renderEmployeesTable(employeesData);
                addLog('Initial employee data loaded', 'success');

            } catch (error) {
                console.error('Error fetching initial data:', error);
                addLog('Error loading data: ' + error.message, 'error');
            }
        }

        // Update stats
        function updateStats(stats) {
            if (stats.totalEmployees !== undefined) {
                document.getElementById('totalEmployees').textContent = extractCount(stats.totalEmployees);
            }
            if (stats.checkedIn !== undefined) {
                document.getElementById('checkedIn').textContent = extractCount(stats.checkedIn);
            }
            if (stats.checkedOut !== undefined) {
                document.getElementById('checkedOut').textContent = extractCount(stats.checkedOut);
            }
            if (stats.absent !== undefined) {
                document.getElementById('absent').textContent = extractCount(stats.absent);
            }
        }

        // Helper function to extract count from various data structures
        function extractCount(data) {
            // If it's already a number, return it
            if (typeof data === 'number') return data;
            
            // If it's an array, get the first element
            if (Array.isArray(data) && data.length > 0) {
                data = data[0];
            }
            
            // If it's an object, try to find the count property
            if (typeof data === 'object' && data !== null) {
                // Try common property names
                const possibleKeys = Object.keys(data);
                if (possibleKeys.length > 0) {
                    // Return the first numeric value found
                    return data[possibleKeys[0]] || 0;
                }
            }
            
            return 0;
        }

        // Render employees table
        function renderEmployeesTable(employees) {
            const container = document.getElementById('employeesTableContainer');
            
            if (!employees || employees.length === 0) {
                container.innerHTML = '<div class="empty-state">No employees found</div>';
                return;
            }

            const tableHTML = `
                <table class="employees-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>First Name</th>
                            <th>Last Name</th>
                            <th>Email</th>
                            <th>Contact</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${employees.map(emp => `
                            <tr>
                                <td>${emp.employee_id || emp.id || '--'}</td>
                                <td>${emp.first_name || '--'}</td>
                                <td>${emp.last_name || '--'}</td>
                                <td>${emp.email || '--'}</td>
                                <td>${emp.contact_no || '--'}</td>
                                <td>
                                    <span class="status-badge ${getStatusClass(emp.attendance_status)}">
                                        ${emp.attendance_status || emp.employment_status || 'Unknown'}
                                    </span>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;

            container.innerHTML = tableHTML;
        }

        // Get status class for badge
        function getStatusClass(status) {
            if (!status) return 'absent';
            const statusLower = status.toLowerCase();
            if (statusLower.includes('in') || statusLower === 'present') return 'checked-in';
            if (statusLower.includes('out')) return 'checked-out';
            return 'absent';
        }

        // Add log entry
        function addLog(message, type = 'info') {
            const logContainer = document.getElementById('activityLog');
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            
            const icon = type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : 'üìù';
            const time = new Date().toLocaleTimeString();
            
            logEntry.innerHTML = `${icon} ${message}<span class="log-time">${time}</span>`;
            
            logContainer.insertBefore(logEntry, logContainer.firstChild);
            
            // Keep only last 20 logs
            if (logContainer.children.length > 20) {
                logContainer.removeChild(logContainer.lastChild);
            }
        }

        // Test functions
        async function addTestEmployee() {
            const firstName = document.getElementById('firstName').value;
            const lastName = document.getElementById('lastName').value;
            const email = document.getElementById('email').value;
            const contact = document.getElementById('contact').value;
            const resultDiv = document.getElementById('addResult');

            if (!firstName || !lastName || !email) {
                resultDiv.className = 'test-result error';
                resultDiv.textContent = '‚ö†Ô∏è Please fill in at least First Name, Last Name, and Email';
                return;
            }

            try {
                // Generate a unique ID (like a national ID or badge number)
                const uniqueId = 'EMP' + Date.now().toString().slice(-8);
                
                const response = await fetch(`${API_URL}/addEmployee`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        first_name: firstName,
                        last_name: lastName,
                        email: email,
                        contact_no: contact || '000-000-0000',
                        address: '123 Test St',
                        id: uniqueId, // Generate unique employee/national ID
                        is_admin: 0, // 0 = regular employee, 1 = admin
                        employment_status: 'Active',
                        date_hired: new Date().toISOString().split('T')[0], // Today's date
                        supervisor_name: 'Test Supervisor', // Required field
                        leave_balance: 20,
                        username: `${firstName.toLowerCase()}.${lastName.toLowerCase()}`,
                        password: 'password123', // Default password
                        classification_id: 1 // Default classification
                    })
                });

                const data = await response.json();
                
                if (response.ok) {
                    resultDiv.className = 'test-result success';
                    resultDiv.textContent = '‚úÖ Employee added! Watch the table update via Socket.IO';
                    addLog(`Added employee: ${firstName} ${lastName}`, 'success');
                    
                    // Clear inputs
                    document.getElementById('firstName').value = '';
                    document.getElementById('lastName').value = '';
                    document.getElementById('email').value = '';
                    document.getElementById('contact').value = '';
                    
                    // Refresh stats
                    setTimeout(fetchInitialData, 500);
                } else {
                    resultDiv.className = 'test-result error';
                    resultDiv.textContent = '‚ùå Error: ' + (data.message || 'Failed to add employee');
                }
            } catch (error) {
                resultDiv.className = 'test-result error';
                resultDiv.textContent = '‚ùå Error: ' + error.message;
                addLog('Error adding employee: ' + error.message, 'error');
            }
        }

        async function deleteTestEmployee() {
            const employeeId = document.getElementById('deleteId').value;
            const resultDiv = document.getElementById('deleteResult');

            if (!employeeId) {
                resultDiv.className = 'test-result error';
                resultDiv.textContent = '‚ö†Ô∏è Please enter an Employee ID';
                return;
            }

            try {
                const response = await fetch(`${API_URL}/removeEmployee/${employeeId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();
                
                if (response.ok) {
                    resultDiv.className = 'test-result success';
                    resultDiv.textContent = '‚úÖ Employee deleted! Watch the table update via Socket.IO';
                    addLog(`Deleted employee ID: ${employeeId}`, 'success');
                    
                    document.getElementById('deleteId').value = '';
                    
                    // Refresh stats
                    setTimeout(fetchInitialData, 500);
                } else {
                    resultDiv.className = 'test-result error';
                    resultDiv.textContent = '‚ùå Error: ' + (data.message || 'Failed to delete employee');
                }
            } catch (error) {
                resultDiv.className = 'test-result error';
                resultDiv.textContent = '‚ùå Error: ' + error.message;
                addLog('Error deleting employee: ' + error.message, 'error');
            }
        }

        async function editTestEmployee() {
            const employeeId = document.getElementById('editId').value;
            const lastName = document.getElementById('editLastName').value;
            const email = document.getElementById('editEmail').value;
            const resultDiv = document.getElementById('editResult');

            if (!employeeId || (!lastName && !email)) {
                resultDiv.className = 'test-result error';
                resultDiv.textContent = '‚ö†Ô∏è Please enter Employee ID and at least one field to update';
                return;
            }

            try {
                const updateData = {};
                if (lastName) updateData.last_name = lastName;
                if (email) updateData.email = email;
                updateData.contact_no = '555-1234';
                updateData.address = 'Updated Address';

                const response = await fetch(`${API_URL}/editEmployee/${employeeId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updateData)
                });

                const data = await response.json();
                
                if (response.ok) {
                    resultDiv.className = 'test-result success';
                    resultDiv.textContent = '‚úÖ Employee updated! Watch the table update via Socket.IO';
                    addLog(`Updated employee ID: ${employeeId}`, 'success');
                    
                    document.getElementById('editId').value = '';
                    document.getElementById('editLastName').value = '';
                    document.getElementById('editEmail').value = '';
                    
                    // Refresh stats
                    setTimeout(fetchInitialData, 500);
                } else {
                    resultDiv.className = 'test-result error';
                    resultDiv.textContent = '‚ùå Error: ' + (data.message || 'Failed to update employee');
                }
            } catch (error) {
                resultDiv.className = 'test-result error';
                resultDiv.textContent = '‚ùå Error: ' + error.message;
                addLog('Error updating employee: ' + error.message, 'error');
            }
        }
    </script>
</body>
</html>
